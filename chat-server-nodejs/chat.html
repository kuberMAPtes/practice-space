<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        
        const socket = io({ path: "/socket.io" });

        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const messages = document.getElementById("messages");
        const chatHistoryButton = document.getElementById("chatHistory")

        // connect to socket.server
        socket.on("connect", (socket) => {
          console.log("Connected to server");
        });

        // receive a broadcasting message from socket server
        socket.on("msg", (chat) => {

          console.log(chat);
          
          const item = document.createElement("li");
          item.textContent = chat;
          messages.appendChild(item);
          //window.scrollTo(0, document.body.scrollHeight) //최하단으로 스크롤;
        });

        // receive a chat from socket server
        socket.on("chat", (chat) => {

        console.log(chat);

        const item = document.createElement("li");
        item.textContent = `😒${chat.nickname} : ${chat.chatMsg} (보낸시간 : ${chat.time}, ${chat['socket.id']})`;
        messages.appendChild(item);
        //window.scrollTo(0, document.body.scrollHeight); //최하단으로 스크롤
        });

        // send a chat to socket server
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          if (input.value) {
            socket.emit("msg", input.value);
            input.value = "";
          }
        });

        // change your nickname
        const nickname_form = document.getElementById("nickname");
        const nickname_input = document.getElementById("nickname_input");

        nickname_form.addEventListener("submit", (e) => {
          e.preventDefault();
          if (nickname_input) {
            socket.emit("nickname", nickname_input.value);
          }
        });

        // show participating chat person number
        const room_personnel = document.getElementById("room_personnel");
        socket.on("room_info", (roomInfo)=>{
            console.log("roomInfo.size", roomInfo.size);
            console.log("roomInfo.rooms", roomInfo.rooms);
            room_personnel.append(`(${roomInfo.size})`);
            
            roomInfo.rooms.forEach((user)=>{
                var room_person = document.createElement("li");
                var textNode = document.createTextNode(user[0]);
                room_person.append(textNode);
                room_personnel.appendChild(room_person);
            })
        })

        
        // bring chat history
        chatHistoryButton.addEventListener('click',  async function() {
           
            try {
                // 서버에 요청을 보내 채팅 기록을 가져옴
                const response = await fetch('/api/chats');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const text = await response.text(); // Read response as text
                const chatHistory = text ? JSON.parse(text) : []; // Parse JSON if not empty

                // 채팅 기록을 콘솔에 출력
                console.log("Chat History:", chatHistory);

                // 채팅 기록을 페이지에 표시
                const chatDisplay = document.getElementById('chatDisplay');
                let chatHistoryHTML = '';
                chatHistory.forEach( (chat) => {
                    chatHistoryHTML += `${chat.nickname} : ${chat.chatMsg} (${chat.time}) <br/>`;
                })
                chatDisplay.innerHTML = chatHistoryHTML;
                
                window.scrollTo(0, document.body.scrollHeight); //최하단으로 스크롤
            } catch (error) {
                console.error("Error fetching chat history:", error);
            }
        });

      });
    </script>
  </head>
  <body>
    <!-- <h3>chat-server-nodejs에서 뿌리는 chat.html 에옹 (프론트)</h3> -->
    <h1>쿠버맵티스 채팅방이에용</h1>
    <br />

    <ul id="room_personnel">채팅 참여 인원 </ul>

    <br />

    <ul id="messages">채팅 내용</ul>
    <form id="form" action="">
      <input id="input" autocomplete="off" /><button>Send</button>
    </form>

    <form id="nickname" action="">
      <input id="nickname_input" autocomplete="off" /><button>
        닉네임 변경
      </button>
    </form>

    <br /><br /><br />
    -----------------------------
    <h3>개발 history</h3>
    24.5.17(금) - 1:1 채팅기능 구현 (완료) <br/>
    24.5.18(토) - 닉네임 변경기능 (완료) <br/>
    24.5.18(토) - 채팅방 인원 수 표시, 최초 채팅방 접속일자 표시 (완료) <br/>
    24.5.19(일) - 채팅방 접속자 표시, 채팅별 전송일자 표시 (완료) <br/>
    24.5.20(월) - 채팅내용 몽고DB 저장하기 (완료) <br/>
    (개념, 코드 gitghub) <br/>
    24.5.21(월) - 채팅방 따로 파기 (예정) <br/>
    ----------------------------- <br/><br/>

    <button id="chatHistory">
        채팅내용불러오기
    </button>
    <pre id="chatDisplay"></pre>
      
  </body>
</html>
